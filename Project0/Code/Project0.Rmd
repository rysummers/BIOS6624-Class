---
title: 'BIOS 6624 : Project 0'
author: "Ryan Summers"
date: "2026-01-22"
output:
  html_document: default
  pdf_document: 
    latex_engine: xelatex
  word_document: default
---

```{r setup, include=FALSE}
library(BiocManager)
library(knitr)
library(ggplot2)
library(tidyverse)
library(magrittr)
library(ggfortify)
library(olsrr)
library(kableExtra)
library(doBy)
library(MASS)
library(dplyr)
library(table1)
library(gtsummary)
library(gt)
library(stringdist)
library(ggrepel)
library(impute)
library(limma)
library(qvalue)
library(gtools)
library(multtest)
library(GEOquery)
library(Biobase)
library(minfi)
library(R.utils)
library(stringr)
library(qs)
library(qs2)
library(lme4)
library(patchwork)
library(lme4)
library(lmerTest)
library(data.table)
library(emmeans)
library(lubridate)
library(naniar)
```


## Read in the csv

```{r}
spit_raw <- read_csv("/Users/ryan_summers/GitHub/BIOS6624-Class/Project0/DataRaw/Project0_Clean_v2.csv")
```

```{r}
# number of subjects
length(unique(spit_raw$SubjectID))
```


```{r}
# number of missing measurements per collection sample
spit_raw %>%
  #filter(`Collection Sample` != 1) %>%
  group_by(`Collection Sample`) %>%
  summarise(
    bk_miss = sum(is.na(`Booket: Clock Time`)),
    mem_miss = sum(is.na(`MEMs: Clock Time`)),
    n_obs = n(),
    `bk_%` = bk_miss/n_obs,
    `mem_%` = mem_miss/n_obs)


```

## Data Management & Cleanup

```{r}
# clean up the column names
spit_df <- spit_raw %>%   
  # lowercase columns & rows
  setNames(tolower(names(.))) %>%
  mutate_if(is.character, tolower) %>% 
  # remove white-space in columns
  setNames(gsub("\\s+", "_", names(.))) 
```

```{r}
spit_df <- spit_df %>% 
  mutate(
    # get weekday for collection dates
    collection_date = as.Date(collection_date, format = "%m/%d/%Y"),
    weekday = weekdays(collection_date),
    # determine if weekday is the weekend
    weekend = factor(if_else(weekday %in% c("Saturday","Sunday"), 
                             "Weekend", "Weekday")),
    # add zeroes for MEMS collection on 1st sample
    `mems:_sample_interval_decimal_time_(mins)` = 
      ifelse(collection_sample == 1, 0, 
             `mems:_sample_interval_decimal_time_(mins)`),
    # log transform responses
    log_cortisol = log(`cortisol_(nmol/l)`),
    log_dhea = log(`dhea_(nmol/l)`),
    # calculate time differences between book and MEM
    time_diff_min = as.numeric(difftime(`booket:_clock_time`, 
                                         `mems:_clock_time`, units = "mins")),
    interval_diff_min = `booklet:_sample_interval_decimal_time_(mins)` - 
      `mems:_sample_interval_decimal_time_(mins)`)

```


Create a datetime variable that merges the collection date and booklet clock time.
* Use this variable as an anchor to determine minutest since wake-up
* Additionally, create a column that stores either booklet or MEM clock time based on whether booklet contains a missing value. **Debate whether this should be used in analysis**

```{r}
spit_df <- spit_df %>%
  mutate(
    # create a variable that includes the date and clock time for booklet and MEMs
    bk_dt = as.POSIXct(paste(collection_date, `booket:_clock_time`),
                            format = "%Y-%m-%d %H:%M", tz = "UTC"),
    mems_dt    = as.POSIXct(paste(collection_date, `mems:_clock_time`),
                            format = "%Y-%m-%d %H:%M", tz = "UTC")) %>% 

group_by(subjectid, collection_date) %>%
  
  mutate(
    # use wake time determined by sleep diary as PI noted
    diary_wake_time = as.POSIXct(
      paste(collection_date, sleep_diary_reported_wake_time),
      format = "%Y-%m-%d %H:%M", tz = "UTC"),
    # fill down datetime values for each subject on each day
    diary_wake_time = fill(data.frame(diary_wake_time), 
                    diary_wake_time, 
                    .direction = "down")$diary_wake_time,

    # extract collection times from booklet, if NA grab MEMs
    sample_dt = coalesce(`booket:_clock_time`, `mems:_clock_time`),
    dt_source = if_else(!is.na(`booket:_clock_time`), "Booklet", "MEMS"),
    
    # calculate time since waking for both booklet and MEMs from diary start
    bk_min_since_wk = as.numeric(difftime(bk_dt, diary_wake_time, 
                                          units = "mins")),
    mem_min_since_wk = as.numeric(difftime(mems_dt, diary_wake_time, 
                                           units = "mins")),
    # create knot for piecewise regression - PI wants to kknow if theres
    # an increase in cortisol and/or DHEA from waking to 30min. Also, rate of
    # decline after 30min of waking.
    t30 = pmin(`mems:_sample_interval_decimal_time_(mins)`, 30),
    t_after30 = pmax(0, `mems:_sample_interval_decimal_time_(mins)`-30),) %>% 
  ungroup()

```



Indicate whether Samples 2 and 4 are within 7.5min and 15min acceptance windows for adherence

```{r}
targets <- c(`2` = 30, `4` = 600)

spit_df2 <- spit_df %>%
  #filter(collection_sample %in% c(2, 4)) %>%
  mutate(
    target_min = targets[as.character(collection_sample)],
    good_bk    = abs(bk_min_since_wk - target_min) <= 7.5,
    adeq_bkt = abs(bk_min_since_wk - target_min) <= 15,
    good_mem    = abs(mem_min_since_wk - target_min) <= 7.5,
    adeq_mem = abs(mem_min_since_wk - target_min) <= 15)

spit_df2 <- spit_df %>%
  mutate(
    target_min = case_when(
      collection_sample == 2 ~ 30,
      collection_sample == 4 ~ 600,
      TRUE ~ NA_real_),
    # booklet times
    good_bk = if_else(
      !is.na(target_min),
      abs(bk_min_since_wk - target_min) <= 7.5,
      NA),
    adeq_bkt = if_else(
      !is.na(target_min),
      abs(bk_min_since_wk - target_min) <= 15,
      NA),
    # MEM times
    good_mem = if_else(
      !is.na(target_min),
      abs(mem_min_since_wk - target_min) <= 7.5,
      NA),
    adeq_mem = if_else(
      !is.na(target_min),
      abs(mem_min_since_wk - target_min) <= 15,
      NA))



```


## Missing Data Analysis

```{r}
# number of NAs
lapply(spit_df, function(x) sum(is.na(x)))
```

```{r}
spit_df %>%
  ungroup() %>% 
  #group_by(collection_sample) %>% 
  select(`booket:_clock_time`, `mems:_clock_time`, `cortisol_(ug/dl)`, `dhea_(pg/dl)`,
         `cortisol_(nmol/l)`, `dhea_(nmol/l)`) %>% 
  miss_var_summary()


```

## Address PI's question about agreement between the subject’s recordings of sampling times compared to the times recorded by an electronic monitoring cap (1)

Scatter-plot of agreement (stratify by collection sample) for PI
```{r}

cor_by_sample <- spit_df %>%
  filter(!is.na(mem_min_since_wk), !is.na(bk_min_since_wk)) %>%
  group_by(collection_sample) %>%
  summarise(
    r = cor(mem_min_since_wk, bk_min_since_wk),
    p = cor.test(mem_min_since_wk, bk_min_since_wk)$p.value)

cor_by_sample

```

```{r}
library(ggpubr)

# plot scatterplots for each collection sample along w/pearson
ggplot(spit_df, aes(x = `mems:_clock_time`, y = `booket:_clock_time`)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype = 2, color = "firebrick3") +
  facet_wrap(~ collection_sample) +
  stat_cor(
    method = "pearson",
    label.x.npc = "left",
    label.y.npc = "top",
    size = 3) +
  labs(
    title = "Booklet vs Cap Collection Time by Sample",
    x = "Cap minutes since wake",
    y = "Booklet minutes since wake") +
  theme_minimal(base_size = 10)

```

Mixed Model: Is there bias in self-reported times, and does it differ by sample, accounting for repeated measurements within subjects?

```{r}
# convert collection sample to factor and create labels for it
spit_df$collection_sample <- factor(
  spit_df$collection_sample,
  labels = c(
    "Wake",
    "+30min",
    "Before lunch",
    "+600min"))

hist(spit_df$time_diff_min)
summary(spit_df$time_diff_min)

## booklet minus mem as outcome
## remove intercept so we are conducting t-tests that each collection time is 
## different from zero
agrmnt.model <- lmer(
  time_diff_min ~ 0 + collection_sample + (1 | subjectid),
  data = spit_df)

summary(agrmnt.model)

```

```{r}
# check residuals to determine if skewness is too extreme for this model approach
plot(agrmnt.model)   # residuals vs fitted
qqnorm(resid(agrmnt.model)); qqline(resid(agrmnt.model))

# try different methods of estimating SEs
confint(agrmnt.model, method = "boot")
library(clubSandwich)
coef_test(agrmnt.model, vcov = "CR2")


```
The distribution of errors are heavily skewed in the tails. Perhaps this modelling approach can still be used but be more descriptive??
* any transformation to the time difference outcome would make interpretation difficult due to the occurrence of zeros, which prevents a log-transform.
* can use boot-strap or robust erros method but this making it more complicated than it needs to be

```{r}
# table for model using collection sample as a fixed effect
tbl_regression(
  agrmnt.model,
  intercept = T,
  estimate_fun = label_style_sigfig(digits = 3),
  pvalue_fun = label_style_pvalue(digits = 3),
    label = list(
    collection_sample ~ "Collection Sample")) %>% 
  as_gt() %>%
  gt::tab_header(title = "Agreement Between Booklet vs Cap",
                 subtitle = "LMM w/ Random Intercept") %>% 
    tab_options(
      table.width = pct(55),
    table.font.size = "small",
    data_row.padding = px(3),
    table.border.top.width = px(2),
    table.border.bottom.width = px(2))
  

```

```{r}
# class recommended one - **debatable**
agrmnt.model2 <- lmer(
  bk_min_since_wk ~  mem_min_since_wk + (1 | subjectid),
  data = spit_df)

summary(agrmnt.model2)

```

```{r}
library(car)
# test that beta=0 (bias) & beta1=1 (agreement)
# conducts a wald test
  # How far is est param from the hypothesized value, relative to its est variability?
car::linearHypothesis(agrmnt.model2,
                      c("(Intercept) = 0", 
                        "mem_min_since_wk = 1"))
```


```{r}
# table for simple linear association between timing methods
tbl_regression(
  agrmnt.model2,
  intercept = T,
  estimate_fun = label_style_sigfig(digits = 3),
  pvalue_fun = label_style_pvalue(digits = 3),
    label = list(
      `(Intercept)` ~ "Intercept",
    mem_min_since_wk ~ "Cap min since waking")) %>% 
  as_gt() %>%
  gt::tab_header(title = "Agreement Between Booklet vs Cap",
                 subtitle = "LMM w/ Random Intercept") %>% 
    tab_options(
      table.width = pct(55),
    table.font.size = "small",
    data_row.padding = px(3),
    table.border.top.width = px(2),
    table.border.bottom.width = px(2))
  
```

Intercept should be zero and slope should be 1. *IF agreement exists*

Correlation is invariant to shifts:
* If Booklet times are always 10 minutes later than Cap, correlation can still be ~1.0.
* High correlation does not mean there is no bias; the mixed model identifies a consistent bias at Sample 2 after accounting for subject-level variability.


## Address PI's question about adhering to +30min and 600min sampling times (2)
and create a table 1 (Descriptive Table)

Create table1
```{r}
# variables used to remove NA calculation for samples 1 and 3
adherence_vars <- c("good_bk", "adeq_bkt", "good_mem", "adeq_mem")

tbl1 <- spit_df2 %>%
  mutate(
    collection_sample = factor(
      collection_sample,
      levels = c(1, 2, 3, 4),
      labels = c(
        "Wake",
        "+30 min",
        "Before lunch",
        "+600 min"))) %>% 
  ungroup() %>% 
  select(
    time_diff_min,
    collection_sample,
    `dhea_(nmol/l)`,
    `cortisol_(nmol/l)`,
    good_bk,
    adeq_bkt,
    good_mem,
    adeq_mem ) %>%
  
  tbl_summary(
    by = collection_sample,
    type = all_continuous() ~ "continuous2",
    statistic = list(
      all_continuous() ~ c(
        "{mean} ({sd})",
        "{median} ({p25}, {p75})",
        "{min} - {max}"),
      all_categorical() ~ "{p}%"),
    
    digits = all_continuous() ~ 1,
    missing = "ifany",
    missing_text = "NA",
    missing_stat = "{p_miss}%",
    
    # change variable names
    label = list(
      time_diff_min ~ "Booklet vs Cap Time",
    `dhea_(nmol/l)` ~ "DHEA (nmol/L)"  ,
    `cortisol_(nmol/l)` ~ "Cortisol (nmol/L)",
    good_bk  ~ "Booklet (±7.5 min)",
    adeq_bkt  ~ "Booklet (±15 min)",
    good_mem ~ "Cap (±7.5 min)",
    adeq_mem ~ "Cap (±15 min)"
    )) %>%
  add_overall() %>%
  # modify_table_body(
  #    ~ .x %>%
  #     mutate(
  #       across(
  #         starts_with("stat_"),
  #         ~ if_else(is.na(.) | str_detect(., "^NA"), "—", .)))) %>% 
  
    modify_table_body(
    ~ .x %>%
      mutate(
        across(
          starts_with("stat_"),
          ~ if_else(
            # only replace NA-looking output for categorical rows / missing rows,
            # and NOT for continuous variables (continuous2 multi-line rows)
            var_type != "continuous" &
              row_type %in% c("level", "missing") &
              (is.na(.) | str_detect(., "^NA")), "—", .)))) %>% 
  
    modify_table_body(
    ~ .x %>%
      mutate(
        # remove Overall NA calculation for adherence variables (misleading to have)
        stat_0 = if_else(row_type == "missing" & variable %in% adherence_vars, 
                         "—", stat_0),
        # remove NA calculation for collection 1 and 3
        stat_1 = if_else(row_type == "missing" & variable %in% adherence_vars, 
                         "—", stat_1),
        stat_3 = if_else(row_type == "missing" & variable %in% adherence_vars, 
                         "—", stat_3))) %>% 
  
    modify_table_body(
    ~ .x %>%
      mutate(
        across(
          starts_with("stat_"),
          ~ if_else(
            # Only touch adherence variables, any row type,
            # and replace anything that is NA / starts with NA (e.g., NA%, NA (NA%))
            variable %in% adherence_vars & (is.na(.) | str_detect(., "^NA")),
            "—", .)))) %>% 
  bold_labels() %>% 
  italicize_levels() %>% 
  add_p(pvalue_fun = label_style_pvalue(digits = 2)) %>% 
  modify_spanning_header(
    c("stat_1", "stat_2", "stat_3", "stat_4") ~ "**Collection Sample**") %>%
  # # kable extra helps with fitting tables within margins of PDF
  # as_kable_extra(format = "latex") %>%
  # kableExtra::kable_styling(
  #   latex_options = c("hold_position", "scale_down", "repeat_header"),
  #   font_size = 8)
  # gt is better looking overall
  as_gt() %>%
  tab_options(
    table.font.size = "small",
    heading.align = "left",
    data_row.padding = px(3),
    table.border.top.width = px(2),
    table.border.bottom.width = px(2))
  

tbl1


```

```{r}
# instances where there is no booklet or mem time recorded but cortisol/dhea
# levels are recorded
spit_df2 %>% 
  filter(is.na(`booket:_clock_time`) & is.na(`mems:_clock_time`))
```


Confirm the rates of adherence are accurate in tbl_summary
```{r}
# booklet = good adherence
spit_df2 %>%
  ungroup() %>% 
  filter(collection_sample %in% c(2, 4)) %>%
  group_by(collection_sample) %>% 
  summarise(
    n_total_rows = n(),
    n_nonmissing = sum(!is.na(good_bk)),
    n_good  = sum(good_bk == T, na.rm = T),
    pct_good = 100 * n_good / n_nonmissing) %>% 
  ungroup()


# mem = good adherence
spit_df2 %>%
  ungroup() %>% 
  filter(collection_sample %in% c(2, 4)) %>%
  group_by(collection_sample) %>% 
  summarise(
    n_total_rows = n(),
    n_nonmissing = sum(!is.na(good_mem)),
    n_good  = sum(good_mem == T, na.rm = T),
    pct_good = 100 * n_good / n_nonmissing) %>% 
  ungroup()
```

Confirm proportions test is accurate in tbl_summary
```{r}
# booklet good test
tab <- spit_df2 %>%
  filter(collection_sample %in% c(2, 4)) %>%
  filter(!is.na(good_bk)) %>%
  with(table(collection_sample, good_bk))

addmargins(tab)
chisq.test(tab)
fisher.test(tab)

```


## Address PI's question about changes of cortisol and DHEA over time (3) 

Identify subjects with cortisol levels over 80 nmol/L and DHEA upper limit of 
5.205 nmol/L. These subjects could have underlying health problems
and should be excluded from analysis

```{r}
# identify subjects with biologically implausible values and DHEA levels at 5.205
spit_df %>% 
  filter(`dhea_(nmol/l)`== 5.205) 

# exclude any observations for patients from analysis
spit_df_filt <- spit_df %>% 
  filter(subjectid != 3037 & `cortisol_(nmol/l)` <= 80) %>% 
  mutate(
    # split time from wake to 30min and after 30min after waking (PI interest)
    # use booklet time as PI requested
    t30 = pmin(bk_min_since_wk, 30),
    t_after30 = pmax(0, bk_min_since_wk - 30))
```

```{r}
# distribution of cortisol and dhea values
summary(spit_df$`cortisol_(nmol/l)`)
hist(spit_df$`cortisol_(nmol/l)`)

summary(spit_df$`dhea_(nmol/l)`)
hist(spit_df$`dhea_(nmol/l)`)
```


```{r}
# log-transformed
hist(log(spit_df$`cortisol_(nmol/l)`))

hist(log(spit_df$`dhea_(nmol/l)`))
```



```{r}
# build cortisol model
cortisol.model <- lmer(log_cortisol ~ t30 + t_after30 + 
                   (1|subjectid),
                 data=spit_df_filt)

summary(cortisol.model)

exp(fixef(cortisol.model))
```

t30:
* During first 30min of waking, cortisol increases 0.62% per minute
* 1.0061531^30 ≈ 1.202049 means cortisol increases by about 20.2% total between waking and 30min

t_after30:
* after 30min, cortisol decreases by about 0.23% per minute
* 0.9977712^60 ≈ 0.8795 or after 30min, cortisol decreases by about 12.5% per hour



```{r}
# build DHEA model
DHEA.model <- lmer(log_dhea ~ t30 + t_after30 + 
                   (1|subjectid),
                 data=spit_df_filt)

summary(DHEA.model)

exp(fixef(DHEA.model))
```

t30:
* During first 30min of waking, DHEA decreases by 1.8% per minute
* 0.9819271^30 ≈ 0.5786 means DHEA decreases by about 42.1% total between waking and 30min

t_after30:
* 1-0.9984475: after 30min, DHEA decreases by about 0.2% per minute
* 0.9984475^60 ≈ 0.911 or after 30min, DHEA decreases by about 8.9% per hour


```{r}
# merge both model outputs into one table for simplicity
tbl_dhea <-
  tbl_regression(
    DHEA.model,
    exponentiate = TRUE,
    intercept = TRUE,
    estimate_fun = label_style_sigfig(digits = 3),
    pvalue_fun = label_style_pvalue(digits = 3),
    label = list(
      t30 ~ "30 min post wake",
      t_after30 ~ "After 30 min")) 

tbl_cort <-
  tbl_regression(
    cortisol.model,
    exponentiate = TRUE,
    intercept = TRUE,
    estimate_fun = label_style_sigfig(digits = 4),
    pvalue_fun = label_style_pvalue(digits = 3),
    label = list(
      t30 ~ "30 min post wake",
      t_after30 ~ "After 30 min"))


tbl_merged <-
  tbl_merge(
    tbls = list(tbl_dhea, tbl_cort),
    tab_spanner = c("**DHEA**", "**Cortisol**")) %>%
  as_gt() %>%
  gt::tab_header(
    title = "Diurnal Patterns",
    subtitle = "Piece-wise Linear Mixed-Effects Models w/ Random Intercepts") 

tbl_merged

```

## Supplemental

Are rate of change different between the two time-segments?

```{r}

tr1 <- emtrends(DHEA.model, specs = ~ 1, var = "t30")
tr2 <- emtrends(DHEA.model, specs = ~ 1, var = "t_after30")

# Combine into one object and contrast
tr_both <- rbind(tr1, tr2)
contrast(tr_both, method = list("t30 - t_after30" = c(1, -1)))


```

Graph the time trends for cortisol and DHEA

```{r}
knot <- 30

newdat <- expand.grid(
  time_min = seq(0, max(spit_df_filt$bk_min_since_wk, na.rm = T), by = 1)) %>%
  mutate(
    t30       = pmin(time_min, knot),
    t_after30 = pmax(time_min - knot, 0))

newdat$fit <- predict(DHEA.model, newdata = newdat, re.form = NA)

# convert back to original units
newdat$exp_fit <- exp(newdat$fit)


ggplot(newdat, aes(x = time_min, y = fit)) +
  geom_line(linewidth = 0.7) +
  geom_vline(xintercept = knot, linetype = 2, color="firebrick3") +
  annotate("text", x = knot, y = max(newdat$fit, na.rm = TRUE),
           label = paste0(knot, " min"), vjust = 3.5, hjust = -0.1,
           size = 4, color = "black") +
  labs(
    title = "Mean log(DHEA) by minutes since waking",
    subtitle = paste0("Piecewise linear slopes with knot at ", knot, " minutes"),
    x = "Minutes since waking",
    y = "Predicted mean log(DHEA)") +
  theme_minimal(base_size = 13)


```








